#!/usr/bin/env bash
# Super Prompt CLI Wrapper - Modernized for MCP-first architecture
set -euo pipefail

# Find the root of the super-prompt installation package.
resolve_app_home() {
  local prg="$0"
  while [ -h "$prg" ]; do
    ls_output=$(ls -ld "$prg")
    link=$(expr "$ls_output" : '.*-> \(.*\)$')
    if expr "$link" : '/.*' > /dev/null; then
      prg="$link"
    else
      prg="$(dirname "$prg")/$link"
    fi
  done
  local saved_dir="$(pwd)"
  cd "$(dirname "$prg")/.." >/dev/null
  local app_home="$(pwd -P)"
  cd "$saved_dir" >/dev/null
  printf "%s" "$app_home"
}

APP_HOME="$(resolve_app_home)"

# Find the project root (git root or current directory).
resolve_project_root() {
  if command -v git &>/dev/null && git rev-parse --show-toplevel &>/dev/null; then
    return 0
  fi
  printf "%s" "$(pwd)"
}

PROJECT_ROOT="$(resolve_project_root)"

# Prefer project venv; fall back to package venv
VENV_DIR_PROJECT="$PROJECT_ROOT/.super-prompt/venv"
VENV_DIR_PACKAGE="$APP_HOME/.super-prompt/venv"

# Resolve the correct Python executable from the venv.
resolve_venv_python() {
    local platform
    platform="$(uname -s 2>/dev/null || echo "Unknown")"

    # Try project venv first, then package venv
    local candidates=()
    case "$platform" in
      Darwin|Linux|*BSD*)
        candidates+=("$VENV_DIR_PROJECT/bin/python")
        candidates+=("$VENV_DIR_PACKAGE/bin/python")
        ;;
      MINGW*|MSYS*|CYGWIN*|Windows_NT*)
        candidates+=("$VENV_DIR_PROJECT/Scripts/python.exe")
        candidates+=("$VENV_DIR_PACKAGE/Scripts/python.exe")
        ;;
      *)
        candidates+=("$VENV_DIR_PROJECT/bin/python")
        candidates+=("$VENV_DIR_PROJECT/Scripts/python.exe")
        candidates+=("$VENV_DIR_PACKAGE/bin/python")
        candidates+=("$VENV_DIR_PACKAGE/Scripts/python.exe")
        ;;
    esac

    for py in "${candidates[@]}"; do
      if [ -f "$py" ]; then
        printf "%s" "$py"
        return 0
      fi
    done

    return 1
}

# Find the venv Python interpreter.
VENV_PYTHON=$(resolve_venv_python || true)

# If the venv Python is not found, fall back to the system python3.
if [ -z "${VENV_PYTHON:-}" ]; then
    echo "-------- WARNING: venv not found. Falling back to system python3." >&2
    VENV_PYTHON="python3"
fi

# With the new module-based approach, we no longer check for the existence
# of a specific source file. The python executable will handle module resolution.
# The python package is installed via the .whl file in install.js.

# Handle subcommands
case "$1" in
  mcp-server)
    shift
    # Export package root so Python can reliably locate packaged assets (.cursor, .codex)
    export SUPER_PROMPT_PACKAGE_ROOT="$APP_HOME"
    export MCP_SERVER_MODE="1"  # Mark as MCP server mode
    exec "$VENV_PYTHON" -m super_prompt.mcp_server "$@"
    ;;
  *)
    # SECURITY: Force MCP-only usage
    # Direct CLI calls are blocked - must use MCP tools
    echo "‚ùå ERROR: Direct CLI usage is disabled."
    echo "üîí Super Prompt must be used through MCP (Model Context Protocol) only."
    echo ""
    echo "üìã Available MCP Tools:"
    echo "  ‚Ä¢ sp.init() - Initialize Super Prompt for current project"
    echo "  ‚Ä¢ sp.refresh() - Refresh Super Prompt assets"
    echo "  ‚Ä¢ sp.list_commands() - List available commands"
    echo "  ‚Ä¢ sp.list_personas() - List available personas"
    echo "  ‚Ä¢ sp.version() - Get version information"
    echo ""
    echo "üîß MCP Client Setup:"
    echo "  Add this to your MCP client configuration:"
    echo ""
    echo '  {'
    echo '    "mcpServers": {'
    echo '      "super-prompt": {'
    echo '        "command": "npx",'
    echo '        "args": ["-y", "@cdw0424/super-prompt@latest", "super-prompt", "mcp-server"],'
    echo '        "env": {'
    echo '          "SUPER_PROMPT_ALLOW_INIT": "true",'
    echo '          "SUPER_PROMPT_PROJECT_ROOT": "${workspaceFolder}"'
    echo '        }'
    echo '      }'
    echo '    }'
    echo '  }'
    echo ""
    echo "üö´ Direct CLI calls like 'npx super-prompt --persona-analyzer' are not allowed."
    exit 1
    ;;
esac
